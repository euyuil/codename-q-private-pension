{% extends "products_layout.html" %}

{% block title %}{{ index.name }} 详情{% endblock %}

{% block main_content %}
<div class="container mt-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">首页</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('main.products') }}">可投产品</a></li>
      <li class="breadcrumb-item">公募基金</li>
      <li class="breadcrumb-item">基金研究</li>
      <li class="breadcrumb-item"><a href="{{ url_for('main.products_funds_research_indices') }}">基准指数</a></li>
      <li class="breadcrumb-item active" aria-current="page"><a href="{{ url_for('main.products_funds_research_index_detail', index_code=index.code) }}">{{ index.name }}</a></li>
    </ol>
  </nav>

  <h1 class="mb-4">{{ index.name }} 详情</h1>
  <table class="table table-bordered">
    <tr>
      <th>代码</th>
      <td>{{ index.code }}</td>
    </tr>
    <tr>
      <th>名称</th>
      <td>{{ index.name }}</td>
    </tr>
    <tr>
      <th>类型</th>
      <td>{{ index.type }}</td>
    </tr>
    <!-- 添加其他必要的字段 -->
  </table>

  <h2 class="mt-5">行情数据（过去 1 年）</h2>
  <canvas id="indexChart" width="400" height="200"></canvas>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 构建 API 请求的 URL
    const apiUrl = "{{ url_for('api.api_funds_research_index_data', index_code=index.code) }}";

    fetch(apiUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok: ' + response.statusText);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }

        const ctx = document.getElementById('indexChart').getContext('2d');
        const indexChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.dates,
            datasets: [{
              label: '{{ index.name }} 收盘价',
              data: data.closing_prices,
              borderColor: 'rgba(75, 192, 192, 1)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              borderWidth: 1,
              pointRadius: 0,  // 去除数据点
              fill: true
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: {
                display: true,
                title: {
                  display: true,
                  text: '日期'
                },
                ticks: {
                  maxTicksLimit: 10,
                  autoSkip: true,
                  maxRotation: 0,
                  minRotation: 0
                }
              },
              y: {
                display: true,
                title: {
                  display: true,
                  text: '收盘价（元）'
                },
                beginAtZero: false
              }
            },
            plugins: {
              tooltip: {
                mode: 'index',
                intersect: false,
              },
              legend: {
                display: true,
                position: 'top',
              }
            },
            interaction: {
              mode: 'nearest',
              axis: 'x',
              intersect: false
            }
          }
        });
      })
      .catch(error => {
        console.error('Error fetching index data:', error);
        alert('无法获取指数数据，请稍后重试。');
      });
  });
</script>
{% endblock %}
